<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"«http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd»>

<html>
    <head>
        <title>Socket AppClient</title>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5/jquery.min.js"></script>
        <script>
           
           $(document).ready(function() {
               
                /*
                * Настройка AJAX
                */
               $.ajaxSetup({url: 'http://localhost/ChallengeServer/index.php', type: 'post', dataType: 'json'});
               
                /*
                * События кнопок и поля ввода
                */
               $('#btnConnect').click(user.Connect);
               $('#btnDisconnect').click(user.Disconnect);
               $('#btnSend').click(user.Send);
               $('#input')
                   .keydown(function(e){ if (e.keyCode == 13) { user.Send();return false; } })
                   .keypress(function(e){ if (e.keyCode == 13) { return false; }})
                   .keyup(function(e){ if (e.keyCode == 13) { return false; } })
                ;
               
            });
           
        </script>
        <script>
           
            /*
             * Лог
             */
            var log = {
               
               print: function(s) {
                  $('#log').append('<div>'+s+'</div>').get(0).scrollTop += 100;
                }
               
            };
           
            /*
             * Действияприсылаемые с сервера
             */
            var actions = {
               
               Connect: function(params) {
                   log.print('Connected.');
                   log.print('Sock: '+params.sock);
                   user.sock = params.sock;
                   user.conn = true;
                   user.Read();
                },
               
               Disconnect: function(params) {
                   log.print('Disconnected.');
                },
               
               Print: function(params) {
                   log.print(params.message);
                }
               
            };
           
            /*
             * Пользователь(клиент)
             */
            var user = {
               
               sock: null,
               
               conn: false,
               
               busy: false,
               
               read: null,
               
                /*
                * Эта функция обрабатывает приходящие с сервера действия и выполняет их.
                */
               onSuccess: function(data) {
                   if (typeof data.actions == 'object') {
                       for (var i = 0; i <data.actions.length; i++) {
                           if (typeofactions[data.actions[i].action] == 'function') {
                              actions[data.actions[i].action](data.actions[i].params);
                           }
                       }
                   }
                },
               
                /*
                * Эта функция выполняется по завершении ajax-запроса.
                */
               onComplete: function(xhr) {
                   if (xhr.status == 404) {
                       actions.Disconnect();
                   }
                   user.busy = false;
                },
               
                /*
                * Эта функция выполняется по завершении запроса-слушания.
                * При удачном завершении запроса (==200) моментальное возобновлениепрослушивания соккета.
                * При неудачном (!=200) возобновление через 5 секунд.
                */
               onCompleteRead: function(xhr) {
                   if (xhr.status == 200) {
                       user.Read();
                   } else {
                       setTimeout(user.Read, 5000);
                   }
                },
               
                /*
                * Действие.
                * Соединение с сервером.
                */
               Connect: function() {
                   if (user.conn == false && user.busy == false) {
                       log.print('Connecting...');
                       user.busy = true;
                       $.ajax({
                           data: 'action=Connect',
                           type: "POST",
                           success:user.onSuccess,
                           complete:user.onComplete
                       });
                   }
                },
               
                /*
                * Действие.
                * Отсоединение от сервера.
                */
               Disconnect: function() {
                   if (user.conn && user.busy == false &&user.read) {
                       log.print('Disconnecting...');
                       user.busy = true;
                       $.ajax({
                           data:'action=Disconnect&sock='+user.sock,
                           success:user.onSuccess,
                           complete:user.onComplete
                       });
                       user.sock = null;
                       user.conn = false;
                       user.read.abort();
                   }
                },
               
                /*
                * Действие.
                * Отправка данных на сервер.
                */
               Send: function() {
                   if (user.conn) {
                       var data = $.trim($('#input').val());
                       if (!data) {
                           return;
                       }
                       $.ajax({
                           data:'action=Send&sock='+user.sock+'&data='+data,
                           success:user.onSuccess,
                           complete:user.onComplete
                       });
                       $('#input').val('');
                   } else {
                       log.print('Please connect.');
                   }
                },
               
                /*
                * Действие.
                * Прослушивание соккета.
                */
               Read: function() {
                   if (user.conn) {
                       user.read = $.ajax({
                           data:'action=Read&sock='+user.sock,
                           success:user.onSuccess,
                           complete:user.onCompleteRead
                       });
                   }
                }
               
            };
           
        </script>
    </head>
   
    <body>
        <input id="btnConnect" type="button" value= "Connect" />
        <input id="btnDisconnect" type="button" value="Disconnect" />
        <div id="log"></div>
        <input id="input" type="text" />
        <input id="btnSend" type="button" value="Send" />
    </body>
   
</html>

